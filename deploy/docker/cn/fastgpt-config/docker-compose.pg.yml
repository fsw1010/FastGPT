# 用于部署的 docker-compose 文件:
# - FastGPT 端口映射为 3000:3000

# plugin auth token
x-plugin-auth-token: &x-plugin-auth-token 'kevin123'
# aiproxy token
x-aiproxy-token: &x-aiproxy-token 'kevin123'

# 数据库连接相关配置
x-share-db-config: &x-share-db-config
  MONGODB_URI: mongodb://kevin:kevin123@mongo:27017/fastgpt?authSource=admin
  DB_MAX_LINK: 100
  REDIS_URL: redis://default:kevin123@redis:6379
  S3_EXTERNAL_BASE_URL: http://192.168.56.1:9000
  S3_ENDPOINT: fastgpt-minio
  S3_PORT: 9000
  S3_USE_SSL: false
  S3_ACCESS_KEY: minioadmin
  S3_SECRET_KEY: minioadmin
  S3_PUBLIC_BUCKET: fastgpt-public
  S3_PRIVATE_BUCKET: fastgpt-private

# 向量库相关配置
x-vec-config: &x-vec-config
  PG_URL: postgresql://kevin:kevin@pg:5432/postgres

version: '3.3'
services:
  # 新增：Xinference 算法推理引擎 (利用 8G 显存)
  xinference:
    image: xprobe/xinference:latest
    container_name: xinference
    restart: always
    networks:
      - fastgpt
    ports:
      - "9997:9997"
    command: xinference-local -H 0.0.0.0
    environment:
      - XINFERENCE_HOME=/data
      - XINFERENCE_MODEL_SRC=modelscope # 国内镜像加速下载
    volumes:
      - ./xinference_data:/data
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  vectorDB:
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/pgvector:0.8.0-pg15
    container_name: pg
    restart: always
    networks:
      - fastgpt
    environment:
      - POSTGRES_USER=kevin
      - POSTGRES_PASSWORD=kevin
      - POSTGRES_DB=postgres
    volumes:
      - ./pg/data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'kevin', '-d', 'postgres']
      interval: 5s
      timeout: 5s
      retries: 10

  mongo:
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/mongo:5.0.32
    container_name: mongo
    restart: always
    networks:
      - fastgpt
    command: mongod --keyFile /data/mongodb.key --replSet rs0
    environment:
      - MONGO_INITDB_ROOT_USERNAME=kevin
      - MONGO_INITDB_ROOT_PASSWORD=kevin123
    volumes:
      - ./mongo/data:/data/db
    healthcheck:
      test: ['CMD', 'mongo', '-u', 'kevin', '-p', 'kevin123', '--authenticationDatabase', 'admin', '--eval', "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    entrypoint:
      - bash
      - -c
      - |
        openssl rand -base64 128 > /data/mongodb.key
        chmod 400 /data/mongodb.key
        chown 999:999 /data/mongodb.key
        echo 'const isInited = rs.status().ok === 1
        if(!isInited){
          rs.initiate({
              _id: "rs0",
              members: [
                  { _id: 0, host: "mongo:27017" }
              ]
          })
        }' > /data/initReplicaSet.js
        exec docker-entrypoint.sh "$$@" &
        until mongo -u kevin -p kevin --authenticationDatabase admin --eval "print('waited for connection')"; do
          sleep 2
        done
        mongo -u kevin -p kevin --authenticationDatabase admin /data/initReplicaSet.js
        wait $$!

  redis:
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/redis:7.2-alpine
    container_name: redis
    networks:
      - fastgpt
    restart: always
    command: |
      redis-server --requirepass kevin123 --loglevel warning --maxclients 10000 --appendonly yes --save 60 10 --maxmemory 4gb --maxmemory-policy noeviction
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', 'kevin123', 'ping']
      interval: 10s
      timeout: 3s
      retries: 3

  fastgpt-minio:
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: fastgpt-minio
    restart: always
    ports:
      - 9000:9000
      - 9001:9001
    networks:
      - fastgpt
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - ./fastgpt-minio:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
      interval: 30s
      timeout: 20s
      retries: 3

  fastgpt:
    container_name: fastgpt
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt:v4.14.4
    ports:
      - 3000:3000
    networks:
      - fastgpt
    depends_on:
      - mongo
      - sandbox
      - vectorDB
    restart: always
    environment:
      <<: [*x-share-db-config, *x-vec-config]
      FE_DOMAIN:
      # 直接连接本地 Ollama
      OPENAI_BASE_URL: http://host.docker.internal:11434/v1
      CHAT_API_KEY: ollama
      DEFAULT_ROOT_PSW: kevin
      TOKEN_KEY: kevin
      ROOT_KEY: kevin
      FILE_TOKEN_KEY: kevin
      AES256_SECRET_KEY: kevin
      PLUGIN_BASE_URL: http://fastgpt-plugin:3000
      PLUGIN_TOKEN: *x-plugin-auth-token
      SANDBOX_URL: http://sandbox:3000
      LOG_LEVEL: info
      STORE_LOG_LEVEL: warn
    volumes:
      - ./config.json:/app/data/config.json

  sandbox:
    container_name: sandbox
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt-sandbox:v4.14.4
    networks:
      - fastgpt
    restart: always

  fastgpt-mcp-server:
    container_name: fastgpt-mcp-server
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt-mcp_server:v4.14.4
    networks:
      - fastgpt
    ports:
      - 3005:3000
    restart: always
    environment:
      - FASTGPT_ENDPOINT=http://fastgpt:3000

  fastgpt-plugin:
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/fastgpt-plugin:v0.3.4
    container_name: fastgpt-plugin
    restart: always
    networks:
      - fastgpt
    environment:
      <<: *x-share-db-config
      AUTH_TOKEN: *x-plugin-auth-token
    depends_on:
      fastgpt-minio:
        condition: service_healthy

  aiproxy:
    image: registry.cn-hangzhou.aliyuncs.com/labring/aiproxy:v0.3.2
    container_name: aiproxy
    restart: unless-stopped
    ports:
      - "3001:3000"
    depends_on:
      aiproxy_pg:
        condition: service_healthy
      xinference: # 依赖本地推理服务
        condition: service_started
    networks:
      - fastgpt
      - aiproxy
    environment:
      ADMIN_KEY: *x-aiproxy-token
      SQL_DSN: postgres://postgres:aiproxy@aiproxy_pg:5432/aiproxy
      BILLING_ENABLED: false
      DISABLE_MODEL_CONFIG: true
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3000/api/status']
      interval: 5s
      timeout: 5s
      retries: 10

  aiproxy_pg:
    image: registry.cn-hangzhou.aliyuncs.com/fastgpt/pgvector:0.8.0-pg15
    restart: unless-stopped
    container_name: aiproxy_pg
    volumes:
      - ./aiproxy_pg:/var/lib/postgresql/data
    networks:
      - aiproxy
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: aiproxy
      POSTGRES_PASSWORD: aiproxy
    healthcheck:
      test: ['CMD', 'pg_isready', '-U', 'postgres', '-d', 'aiproxy']
      interval: 5s
      timeout: 5s
      retries: 10

networks:
  fastgpt:
  aiproxy: